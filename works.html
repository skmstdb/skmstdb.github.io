<!DOCTYPE html>
<html lang="ja">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6C7BJGKMFT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-6C7BJGKMFT');
    </script>
    <meta charset="UTF-8">
    <script src="js/visibility.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="堺雅人の出演作品と、各動画配信サービスでの視聴方法を一覧で紹介。映画やドラマをどこでオンライン視聴できるか、詳細な情報をチェック！ / Explore Sakai Masato's works and where to watch them on streaming services. Find out where to watch his movies and dramas online.">
    <meta name="keywords"
        content="堺雅人, 出演作品, 映画, テレビドラマ, 動画配信サービス, データベース, Sakai Masato, Film, Movie, TV, Shows, Series, Database">
    <title>Sakai Masato Database</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="icon" href="favicon-32x32.png" sizes="32x32" />
    <link rel="apple-touch-icon" href="pic/apple-touch-icon.png">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="Navi/navi.css">
    <script src="js/darkmode.js"></script>
    <script src="Navi/navHighlight.js"></script>

    <!-- Google Fonts: Noto Serif JP -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;600;700;900&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-color: #f6f4ef;
            --text-color: #333333;
            --panel-bg: #ffffff;
            --timeline-line: #ddd;
            --timeline-dot: #333333;
            --border-color: #ddd;
            --accent-color: #333333;
        }

        .dark-mode {
            --bg-color: #121212;
            --text-color: #ffffff;
            --panel-bg: #1e1e1e;
            --timeline-line: #555;
            --timeline-dot: #e0e0e0;
            --border-color: #555;
            --accent-color: #e0e0e0;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
        }

        body {
            display: flex;
            flex-direction: row;
        }

        .sidebar {
            width: calc(100% / 7);
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            z-index: 10;
            flex-shrink: 0;
            box-sizing: border-box;
            background: var(--bg-color);
            border-right: 1px solid var(--border-color);
        }

        .main-content-wrapper {
            width: calc(6 * 100% / 7);
            margin-left: calc(100% / 7);
            padding: 40px;
            box-sizing: border-box;
            background-color: var(--bg-color);
            min-height: 100vh;
        }

        .content-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .title {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .stats-summary {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
            font-size: 14px;
            color: #666;
        }

        .dark-mode .stats-summary {
            color: #aaa;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-number {
            font-weight: 700;
            font-size: 18px;
            color: var(--accent-color);
        }

        .filter-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 40px;
        }

        .filter-btn {
            padding: 8px 20px;
            border: 1px solid var(--border-color);
            background: var(--panel-bg);
            color: var(--text-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-btn:hover {
            background: var(--accent-color);
            color: var(--bg-color);
            border-color: var(--accent-color);
        }

        .filter-btn.active {
            background: var(--accent-color);
            color: var(--bg-color);
            border-color: var(--accent-color);
        }

        .timeline-container {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            padding: 20px 0 0 0;
        }

        /* Timeline vertical line */
        .timeline-container::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--timeline-line);
            transform: translateX(-50%);
        }

        .timeline-year {
            position: relative;
            margin-bottom: 40px;
        }

        .timeline-year:last-child {
            margin-bottom: 0;
        }

        .timeline-year:last-child .year-label {
            margin-bottom: 0;
        }

        .year-label {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 30px;
            color: var(--accent-color);
            background: var(--bg-color);
            padding: 10px 20px;
            display: inline-block;
            position: relative;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
        }

        .timeline-items {
            position: relative;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            width: calc(45% - 30px);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Lead roles on the right */
        .timeline-item.lead-role {
            margin-left: calc(55% + 30px);
            padding-left: 30px;
        }

        /* Non-lead roles on the left */
        .timeline-item.non-lead-role {
            margin-left: 0;
            padding-right: 30px;
        }

        .timeline-content {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .timeline-content:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border-color: var(--accent-color);
        }

        .dark-mode .timeline-content:hover {
            box-shadow: 0 8px 20px rgba(255, 255, 255, 0.1);
        }

        .work-title {
            font-family: 'Noto Serif JP', serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-color);
            margin: 0;
        }

        .work-name {
            font-family: 'Noto Serif JP', serif;
            font-size: 14px;
            font-weight: 500;
            margin-top: 8px;
            color: #666;
        }

        .dark-mode .work-name {
            color: #aaa;
        }

        .empty-year {
            display: none;
        }

        /* Mobile responsive */
        @media (max-width: 767px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 60px;
                position: fixed;
                top: 0;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .main-content-wrapper {
                width: 95%;
                margin-left: auto;
                margin-right: auto;
                padding: 20px;
                padding-top: 80px;
            }

            .title {
                font-size: 28px;
            }

            .stats-summary {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }

            .filter-buttons {
                gap: 8px;
            }

            .filter-btn {
                padding: 6px 15px;
                font-size: 12px;
            }

            /* Single column timeline on mobile */
            .timeline-container::before {
                left: 20px;
            }

            .timeline-item,
            .timeline-item.lead-role,
            .timeline-item.non-lead-role {
                width: 100%;
                margin-left: 0;
                padding-left: 50px;
                padding-right: 0;
            }

            .year-label {
                font-size: 20px;
                left: 20px;
                transform: none;
            }
        }

        /* Tablet responsive */
        @media (min-width: 768px) and (max-width: 1024px) {
            .timeline-container {
                max-width: 700px;
            }
        }

        /* Skeleton loading animation */
        .skeleton-year {
            opacity: 1;
        }

        .skeleton-label,
        .skeleton-content {
            background: linear-gradient(90deg,
                    var(--panel-bg) 25%,
                    var(--border-color) 50%,
                    var(--panel-bg) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        .skeleton-label {
            color: transparent;
        }

        .skeleton-item {
            opacity: 1 !important;
            transform: translateY(0) !important;
            animation: none !important;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body>
    <aside class="sidebar">
        <!-- Navbar content will be loaded here -->
    </aside>

    <div class="main-content-wrapper">
        <div class="content-header">
            <h1 class="title">WORKS</h1>
            <div class="stats-summary" id="stats-summary">
                <!-- Stats will be injected here -->
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">全て</button>
                <button class="filter-btn" data-filter="映画">映画</button>
                <button class="filter-btn" data-filter="TV">TV</button>
                <button class="filter-btn" data-filter="舞台">舞台</button>
                <button class="filter-btn" data-filter="声の出演">声の出演</button>
                <button class="filter-btn" data-filter="その他">その他</button>
                <button class="filter-btn" data-filter="BOOK">BOOK</button>
                <button class="filter-btn" data-filter="lead">主演作品</button>
            </div>
        </div>

        <div class="timeline-container" id="timeline-container">
            <!-- Skeleton timeline items for loading feedback -->
            <div class="timeline-year skeleton-year">
                <div class="year-label skeleton-label">Loading...</div>
                <div class="timeline-items">
                    <div class="timeline-item lead-role skeleton-item">
                        <div class="timeline-content skeleton-content"></div>
                    </div>
                    <div class="timeline-item non-lead-role skeleton-item">
                        <div class="timeline-content skeleton-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allWorks = [];
        let currentFilter = 'all';

        // ============================================
        // INITIALIZATION - Ensure navbar loads first
        // ============================================
        document.addEventListener('DOMContentLoaded', async function () {
            // 1. Load navbar first (explicit control)
            // Note: loadNavbar() already calls highlightCurrentPage() and initializeHamburger()
            if (typeof loadNavbar === 'function') {
                await loadNavbar();
            }

            // 2. Then load main content
            await loadData();
        });

        // Parse CSV and generate timeline
        async function loadData() {
            try {
                const response = await fetch('/data/biography.csv');
                const data = await response.text();
                const rows = data.split('\n').slice(1); // Skip header

                allWorks = rows
                    .map(row => {
                        const cols = [];
                        let current = '';
                        let inQuotes = false;

                        for (let i = 0; i < row.length; i++) {
                            const char = row[i];
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                cols.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        cols.push(current.trim());

                        if (cols.length < 16) return null;

                        // PageWorks,PageActivity,PageToday,PageCalendar,PageAnn,Year,Name,Title,Role,WorksType,DateStart,DateEnd,Weekday,DateAdd,DateDelete,URL
                        const dateStartStr = cols[10];
                        let dateStart = null;
                        if (dateStartStr && dateStartStr.trim() !== '') {
                            const parts = dateStartStr.split('/');
                            if (parts.length === 3) {
                                dateStart = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                            }
                        }

                        return {
                            pageWorks: cols[0],
                            year: parseInt(cols[5]) || 0,
                            name: cols[6],
                            title: cols[7],
                            role: cols[8],
                            type: cols[9],
                            dateStart: dateStart,
                            url: cols[15]
                        };
                    })
                    .filter(work => work && work.pageWorks && work.pageWorks.trim() !== '' && work.year > 0);

                // Sort by year descending, then by date descending
                allWorks.sort((a, b) => {
                    if (b.year !== a.year) {
                        return b.year - a.year;
                    }
                    if (a.dateStart && b.dateStart) {
                        return b.dateStart - a.dateStart;
                    }
                    return 0;
                });

                generateTimeline(allWorks);
                setupFilterButtons();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function setupFilterButtons() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all buttons
                    filterButtons.forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    btn.classList.add('active');

                    const filter = btn.dataset.filter;
                    currentFilter = filter;

                    let filteredWorks = allWorks;
                    if (filter === 'all') {
                        filteredWorks = allWorks;
                    } else if (filter === 'lead') {
                        filteredWorks = allWorks.filter(w => w.role && w.role.includes('主演'));
                    } else {
                        filteredWorks = allWorks.filter(w => w.type === filter);
                    }

                    generateTimeline(filteredWorks);
                });
            });
        }

        function generateTimeline(works) {
            const totalWorks = works.length;
            const leadRoles = works.filter(w => w.role && w.role.includes('主演')).length;

            // Generate stats summary based on filtered works
            const statsSummary = document.getElementById('stats-summary');
            statsSummary.innerHTML = `
                <div class="stat-item">
                    <span class="stat-number">${totalWorks}</span>
                    <span>in Total</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${leadRoles}</span>
                    <span>主演</span>
                </div>
            `;

            // Group works by year
            const worksByYear = {};
            works.forEach(work => {
                if (!worksByYear[work.year]) {
                    worksByYear[work.year] = [];
                }
                worksByYear[work.year].push(work);
            });

            // Generate all years from 1992 to current year (or max year in data)
            const currentYear = new Date().getFullYear();
            const maxYearInData = Math.max(...allWorks.map(w => w.year));
            const endYear = Math.max(currentYear, maxYearInData);
            const startYear = 1992;

            // Generate years list: [endYear, ..., 1992, 1973]
            const yearsToRender = [];
            for (let y = endYear; y >= startYear; y--) {
                yearsToRender.push(y);
            }
            yearsToRender.push(1973);

            // Prepare year sections data
            const yearSectionsData = yearsToRender.map(year => ({
                year,
                works: worksByYear[year] || []
            }));

            // Clear skeleton and render progressively
            const timelineContainer = document.getElementById('timeline-container');
            timelineContainer.innerHTML = '';

            renderTimelineProgressively(yearSectionsData, timelineContainer);
        }

        // ============================================
        // CREATE YEAR SECTION - Extracted for clarity
        // ============================================
        function createYearSection(yearData) {
            const { year, works } = yearData;

            const yearDiv = document.createElement('div');
            yearDiv.className = 'timeline-year';

            const yearLabel = document.createElement('div');
            yearLabel.className = 'year-label';
            yearLabel.textContent = year;
            yearDiv.appendChild(yearLabel);

            const itemsDiv = document.createElement('div');
            itemsDiv.className = 'timeline-items';

            if (works && works.length > 0) {
                works.forEach((work, index) => {
                    const isLead = work.role && work.role.includes('主演');
                    const roleClass = isLead ? 'lead-role' : 'non-lead-role';

                    const itemDiv = document.createElement('div');
                    itemDiv.className = `timeline-item ${roleClass}`;
                    itemDiv.style.animationDelay = `${index * 0.1}s`;
                    itemDiv.onclick = () => window.open(work.url, '_blank');

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'timeline-content';

                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'work-title';
                    titleDiv.textContent = work.title || work.name;
                    contentDiv.appendChild(titleDiv);

                    if (work.name && work.title) {
                        const nameDiv = document.createElement('div');
                        nameDiv.className = 'work-name';
                        nameDiv.textContent = work.name;
                        contentDiv.appendChild(nameDiv);
                    }

                    itemDiv.appendChild(contentDiv);
                    itemsDiv.appendChild(itemDiv);
                });
            }

            yearDiv.appendChild(itemsDiv);
            return yearDiv;
        }

        // ============================================
        // PROGRESSIVE RENDERING - Render in batches
        // ============================================
        function renderTimelineProgressively(yearSectionsData, container) {
            return new Promise((resolve) => {
                const BATCH_SIZE = 3; // Render 3 years per frame
                let currentIndex = 0;

                function renderBatch() {
                    const endIndex = Math.min(currentIndex + BATCH_SIZE, yearSectionsData.length);

                    for (let i = currentIndex; i < endIndex; i++) {
                        const yearSection = createYearSection(yearSectionsData[i]);
                        container.appendChild(yearSection);
                    }

                    currentIndex = endIndex;

                    if (currentIndex < yearSectionsData.length) {
                        requestAnimationFrame(renderBatch);
                    } else {
                        resolve();
                    }
                }

                renderBatch();
            });
        }

        // Original timeline generation logic (now replaced by progressive rendering above)
        function generateTimelineOld_UNUSED(works) {
            // This function is kept for reference but not used
            // The new implementation uses progressive rendering
            const totalWorks = works.length;
            const leadRoles = works.filter(w => w.role && w.role.includes('主演')).length;

            // Generate stats summary based on filtered works
            const statsSummary = document.getElementById('stats-summary');
            statsSummary.innerHTML = `
                <div class="stat-item">
                    <span class="stat-number">${totalWorks}</span>
                    <span>in Total</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${leadRoles}</span>
                    <span>主演</span>
                </div>
            `;

            // Group works by year
            const worksByYear = {};
            works.forEach(work => {
                if (!worksByYear[work.year]) {
                    worksByYear[work.year] = [];
                }
                worksByYear[work.year].push(work);
            });

            // Generate all years from 1992 to current year (or max year in data)
            const currentYear = new Date().getFullYear();
            const maxYearInData = Math.max(...allWorks.map(w => w.year));
            const endYear = Math.max(currentYear, maxYearInData);
            const startYear = 1992;
        }


    </script>
</body>

</html>
